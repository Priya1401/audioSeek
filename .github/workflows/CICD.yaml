name: AudioSeek CI Pipeline

on:
  push:
    branches: ["main", "refactor", "dev"]
  pull_request:
    branches: ["main", "refactor", "dev"]
  workflow_dispatch:

jobs:
  # ------------------------------------------------------
  # 1) Unit / Integration Tests
  # ------------------------------------------------------
  run-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r Data-Pipeline/requirements-airflow.txt

    - name: Run test suite
      working-directory: Data-Pipeline
      run: |
        pytest scripts/tests/test_transcription.py
        pytest scripts/tests/test_transcription_tasks.py
        pytest scripts/tests/test_summary.py

  # ------------------------------------------------------
  # 2) MLflow job (exercise MLflow-logged code paths)
  # ------------------------------------------------------
  mlflow-run:
    runs-on: ubuntu-latest
    needs: run-tests   # only run if tests pass

    env:
      # Local MLflow file backend for CI
      MLFLOW_TRACKING_URI: "file:./mlruns-ci"
      MLFLOW_EXPERIMENT_NAME: "AudioSeek-CI"
      # If your config_mlflow also reads this:
      MLFLOW_EXPERIMENT: "AudioSeek-CI"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install service + MLflow dependencies
        working-directory: Data-Pipeline
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-services.txt
          pip install mlflow

      # ðŸ”¹ Replace this with a real script/tests that call the MLflow-logged paths:
      #   - PipelineService.process_full_pipeline(...)
      #   - QAService.ask_question(...)
      #   - or hit FastAPI endpoints with TestClient
      - name: Run MLflow smoke tests
        working-directory: Data-Pipeline
        run: |
          echo "TODO: Replace this with a script that calls /process-full, /qa/ask, /chunk, /embed, etc."
          # Example once you have it:
          # python scripts/mlflow_smoke_test.py

      - name: Upload MLflow runs as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-ci-runs
          path: Data-Pipeline/mlruns-ci

  # ------------------------------------------------------
  # 3) (Future) Docker build & push job
  # ------------------------------------------------------
  # docker-build-and-push:
  #   runs-on: ubuntu-latest
  #   needs: [run-tests, mlflow-run]
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #     - name: Log in to registry
  #       ...
  #     - name: Build and push image
  #       ...
